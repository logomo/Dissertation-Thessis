\cleardoublepage
\section{\secState{R}Space Discretization - Avoidance Grid}\label{s:AvoidanceGrid}

\paragraph{Operation Space:} The \emph{Operation Space} is a space where UAS can effectively surveillance its surroundings.

\paragraph{Motivation for Discretization:} The UAS surroundings needs to be represented in \emph{avoidance-friendly manner}, following principles matters:

\begin{enumerate}
	\item \emph{Discrete representation} - the space around UAS should be segmented into finite and exclusive portions which are considered as one point of the grid. This enables fast situation assessment. 
	
	\item \emph{Threat proximity} - threat in any form is getting more important with decreasing distance to UAS.
	
	\item \emph{LiDAR swipe density} - one LiDAR swipe scans a lot of points, the grid need to be customized to swipe characteristics.
\end{enumerate}


The \emph{Main Sensor} is \emph{LiDAR} (problems \ref{eq:basicProblemDefinition}.-\ref{pro:rulesOfTheAir}).  The \emph{effective occupancy computation} needs to be done for all problems; the inspiration is taken from \cite{homm2010efficient}.  The \emph{effective occupancy computation} is done in \emph{LiDAR} scan  clustered into \emph{polar coordinates grid}. The\emph{operation space} is going to be segmented into \emph{grid} where \emph{space portions} are represented as points in the grid.

\begin{note}
	Each member of the grid is a cell, represented as a point with shared properties, like threat level, visibility.
\end{note}

The \emph{Discrete Situation Evaluation} is executed for \emph{UAS} local coordinate frame in fixed \emph{time}.  The goal is to enable \emph{fast situation assessment}. 


\paragraph{LiDAR Swipe:} The \emph{point} scanned by \emph{LiDAR}, where \emph{UAS position} is center of \emph{local coordinate frame} and \emph{UAS heading is defining the main axes} is given as:

\begin{equation}\label{eq:LiDARPoint}
    point = [distance,horizontal^\circ,vertical^\circ].
\end{equation}

\begin{note}
    For polar/euclidean transformations and local/global coordinate frames refer to background theory (app. \ref{sec:complementsOfAlgebra}). 
    
    The \emph{right side} of UAS $horizontal^\circ$ $\in$ $]-\pi,0[$, the \emph{left side} of UAS $horizontal^\circ$ $\in$ $[0,\pi]$, the \emph{down side} of UAS $vertical^\circ$ $\in$ $]-\pi,0[$, the \emph{top side} of UAS $vertical^\circ$ $\in$ $[0,\pi]$
\end{note}

\paragraph{LiDAR Swipe Portioning:} The \emph{polar coordinate space} can be portioned into distingtive cells, which contains the portion the space. This cell then represents one point in the grid.

The \emph{reason} for this swipe portioning is \emph{LiDAR} scanning density\footnote{Example rotary LiDAR Velodyne VL-16 specs: \url{https://www.cadden.fr/wp-content/uploads/2017/02/Velodyne_VLP-16-Puck.pdf}}, which is extremly dense. The \emph{threat} state in the cell can be assessed with linear complexity. 

The \emph{polar $\to$ euclidean} coordinate frame transformation is not amenable  for LiDAR swipe. The \emph{threath} assessment based on \emph{LiDAR swipe} in \emph{planar space portions}
has minimal complexity and it is cost effective. \cite{gupta2010comparative}.


\paragraph{Cell:} To discretize operational space into grid of points there is a need to define cell space, which will bound the portion of \emph{local planar coordinate frame}. The point (eq. \ref{eq:LiDARPoint}) is defined by distance, horizontal$^\circ$ offset angle, and vertical$^\circ$ offset angle. The cell is a closed compact set of such points. There is a need to define boundaries like follow: 

\begin{definition}{Cell}\label{def:cell}
	
    The \emph{cell} bounds a portion of space in UAS local polar coordinate frame, defined by boundary ranges:
    \begin{enumerate}
        
        \item \emph{Distance Range} -  starts and ends: $distance_{start}$ $<$ $distance_{end}$ $in$ $\R^+$.
        
        \item \emph{Horizontal Range} - starts and ends: $horizontal^\circ_{start}$ $<$ $horizontal^\circ_{end}$ $\in$ $]-\pi,\pi]$.
        
        \item \emph{Vertical Range} - starts and ends: by $vertical^\circ_{start}$ $<$ $vertical^\circ_{start}$ $\in$ $]-\pi,\pi]$.
    \end{enumerate}
    
    \noindent The \emph{bounded space} of \emph{cell} is given by function as:
    
    \begin{multline}\label{eq:boundedSpaceCell}
        cell.space Portion\dots\\
            \left \{
                \begin{aligned}
                point& \in \R^3 \text{ where}:\\
                    &\left(\begin{aligned}
                        cell.distance_{start} &<& point.distance &\le& cell.distance_{end},\\
                        cell.horizontal^\circ_{start} &<& point.horizontal^\circ &\le&  cell.horizontal^\circ_{end},\\
                        cell.vertical^\circ_{start} &<& point.vertical^\circ &\le& cell.vertical^\circ_{end}\\
                    \end{aligned}\right)
                \end{aligned}
            \right\}
    \end{multline}
    
    \noindent For one \emph{LiDAR Scan} the \emph{hits set} is given as \emph{set} of \emph{all points} which lands into cell space portion:
    \begin{equation}\label{eq:LidarHitsCell}
        cell. LiDAR Hits = \left\{point \in Lidar Scan:  point \in cell. space Portion\right\}    
    \end{equation}
    
    %\noindent The \emph{passing hits} for cell are hits which are going through the cell (passing), but it lands in distance greater than $cell.distance_{end}$, defined as:
%    \begin{multline}\label{eq:passingHitsCell}
%        Passing Hits(cell)=
%        \dots\\
%            \left \{
%                \begin{aligned}
%                point& \in Lidar Scan \text{ where}:\\
%                    &\left(\begin{aligned}
%                        cell.distance_{end}&<& point.distance &&,\\
%                        cell.horizontal^\circ_{start} &<& point.horizontal^\circ &\le&  %cell.horizontal^\circ_{end},\\
%                        cell.vertical^\circ_{start} &<& point.vertical^\circ &\le& %cell.vertical^\circ_{end}\\
%                    \end{aligned}\right)
%                \end{aligned}
%            \right\}
%    \end{multline}
\end{definition}

\begin{note}
    The \emph{cell} space portion volume is increasing with distance. This satisfy the requirement for threat-distance importance.  The cell is considered as a point of grid with common properties abstraction valid for all cell space portion.    
\end{note}

\paragraph{Effective Operation Space:} The goal is to determine which of the operation space is going to be considered in our avoidance grid.  The effective operation space determination according to \cite{zaiane2002clustering} is influenced by the following factors:

\begin{enumerate}
        \item \emph{Sensors ranges} -  there is no reason to assess situation over effective \emph{sensor range}.
        
        \item \emph{Information sources} impact - there is no real impact on \emph{effective space boundary}.
        
        \item \emph{UAS maneuverability} - the space where UAS can maneuver, bounded by space-time (reach set boundary). 
        
        \item \emph{Computation power} - the situation evaluation and threat assessment capabilities of onboard computer.
        
        \item \emph{Airworthiness requirements} - the \emph{regulations} can impose some minimal requirements on \emph{effective operation space boundary}.
\end{enumerate}

Let show an example of \emph{effective operation space} for the UAS  (fig. \ref{fig:LidarSpaceSegmentation}).  The \emph{full LiDAR Swipe} (cyan and red lines) of \emph{UAS} (blue plane) has \emph{shape} of conical cylinder. 

\begin{note}
Under \emph{ideal circumstances} the \emph{LiDAR swipe} would have \emph{ball shape}, but in real cases the \emph{craft body portion} where \emph{LiDAR} is mounted is unused.
\end{note}

The \emph{frontal portion} (red line) is a set of cells where \emph{UAS} can make maneuvers. According to the \emph{previous conditions}, there is no reason to consider space portion out of the maneuverable area. 

\begin{figure}[H]
    \centering
    \includegraphics[width=0.80\linewidth]{\FIGDIR/TE046LiDARRasterRange} 
    \caption{Example: The \emph{LiDAR} reading portioning - cells.}
    \label{fig:LidarSpaceSegmentation}
\end{figure}

\paragraph{Avoidance Grid Definition:} The \emph{effective operation space} is going to be portioned into cells. The set of these cells is going to be called \emph{Avoidance Grid}. The idea is to split operational space into cells with even distance, horizontal angle, and vertical angle ranges. 

\begin{definition}{Avoidance Grid}\label{def:AvoidanceGrid} The \emph{effective space portion} (fig. \ref{fig:LidarSpaceSegmentation} red lines) given by a portion of space in UAS local polar coordinate frame, bounded by:
    \begin{enumerate}
        \item \emph{Distance Range} -  start-end: $distance_{start}$ $<$ $distance_{end}$ $in$ $\R^+$.
        \item \emph{Horizontal Range} - bounded by $horizontal^\circ_{start}$ $<$ $horizontal^\circ_{start}$ $\in$ $]-\pi,\pi]$.
        \item \emph{Vertical Range} - bounded by $vertical^\circ_{start}$ $<$ $vertical^\circ_{start}$ $\in$ $]-\pi,\pi]$.
    \end{enumerate}

\noindent Separated into \emph{layers} depending on the distance and \emph{layer count}:
\begin{equation}\label{eq:avoidanceGridCellDistanceRange}
    \begin{aligned}
        layer^i_{start} & = (i-1)\times\frac{distance_{end}-distance_{start}}{layer Count}\\
        layer^i_{end} & = i\times\frac{distance_{end}-distance_{start}}{layer Count}
    \end{aligned};\quad i\in 1\dots I
\end{equation}

\noindent Layer horizontal/vertical separations separations defined by horizontal/vertically cell count:

\begin{equation}\label{eq:avoidanceGridCellHorizontalRange}
    \begin{aligned}
        horizontal^j_{start} & = (j-1)\times\frac{horizontal^\circ_{end}-horizontal^\circ_{start}}{horizontal Count}\\
        horizontal^j_{end} & = j\times\frac{horizontal^\circ_{end}-horizontal^\circ_{start}}{horizontal Count}
    \end{aligned};\quad j\in 1\dots J
\end{equation}

\begin{equation}\label{eq:avoidanceGridCellVerticalRange}
    \begin{aligned}
        vertical^k_{start} & = (k-1)\times\frac{vertical^\circ_{end}-vertical^\circ_{start}}{vertical Count}\\
        vertical^k_{end} & = k\times\frac{vertical^\circ_{end}-vertical^\circ_{start}}{vertical Count}
    \end{aligned};\quad k\in 1\dots K
\end{equation}

\noindent Then $cell_{i,j,k}$ given by (def. \ref{def:cell}) is member cell of Avoidance Grid for boundaries:
\begin{enumerate}
    \item \emph{Cell Distance Range} (eq. \ref{eq:avoidanceGridCellDistanceRange}) depending on layer index $i$.
    
    \item \emph{Cell Horizontal Range} (eq. \ref{eq:avoidanceGridCellHorizontalRange}) depending on horizontal index $j$.
    
    \item \emph{Cell Vertical Range} (eq. \ref{eq:avoidanceGridCellVerticalRange}) depending on horizontal index $k$.
\end{enumerate}

\noindent The example of \emph{Avoidance Grid Cells} is given in (fig. \ref{fig:LidarSpaceSegmentation} red boundary). 

The \emph{Avoidance Grid} is then given as set of cells:

\begin{equation}\label{eq:avoidanceGridCellSpace}
    Avoidance Grid = \bigcup cell_{i,j,k} \forall i \in 1\dots I, j\in 1\dots J, k\in 1\dots K
\end{equation}
\end{definition}

\paragraph{Trajectory Intersection:} The \emph{trajectory} intersection with \emph{Avoidance Grid} is solved in context of \emph{Reach Set Approximation} (def. \ref{def:ContainedReducedReachSet}). 
\begin{note}
    The \emph{trajectory intersection} function does not have an impact on \emph{Reach Set Approximation}, because its done prior the flight.
\end{note}


\paragraph{Grid Scaling:} For \emph{Sensor Field} there is \emph{effective sensor boundary} given as set:
\begin{equation}
    Boundary(Sensor \in Sensor Field) = \{points \in \R^3: \text{where reliable}\}
\end{equation}

\noindent The \emph{Boundary} for sensor fields is then given as \emph{union of all singe sensor boundaries}:

\begin{equation}
     Boundary(Sensor Field) = \bigcap_{\forall Sensors} Boundary(Sensor \in Sensor Field)
\end{equation}

\noindent Depending on boundary properties it can be projected into maximal avoidance grid boundary values:
\begin{equation}
    Boundary(Sensor Field) \to Avoidance Grid : 
    \begin{gathered}
        \max(distanceRange)\\
        \max(horizontalRange)\\
        \max(verticalRange)\\
    \end{gathered}
\end{equation}

\noindent Our approach taken worst LiDAR performance into account \cite{sabatini2014lidar} and following parameters for avoidance grid were calculated:

\begin{enumerate}
    \item distance range $[0m,10m]$,
    \item horizontal range $]-180^\circ,180^\circ]$,
    \item vertical range $[-30^\circ,30^\circ]$.
\end{enumerate}

\noindent The \emph{count of layers} is derived from \emph{average distance traveled by one movement application}:

\begin{equation}
    layer Count = \frac{|distance Range|}{\text{avg.}\quad length(movement\in Movement Set)}
\end{equation}

\noindent The \emph{layer length} is based on \emph{our movement set} (tab. \ref{tab:movements1}, \ref{tab:movements2}) the average movement length is 1 m, therefore the \emph{layer count} is 10.

The \emph{efficient boundary} is given by  \emph{Reach Set}. Estimate reach set coverage space using \emph{ellipsoidal toolbox} \cite{kurzhanskiy2006ellipsoidal} up to given \emph{sensor field} maximal distance:

\begin{equation}
    Boundary(Reach Set) = Ellipsoid(UAS System,distance)
\end{equation}

The values for \emph{Reach Set Boundary} with distance 10 m was following:
\begin{enumerate}
    \item distance range $[0m,10m]$,
    \item horizontal range $[-45^\circ,45^\circ]$,
    \item vertical range $[-45^\circ,45^\circ]$,
\end{enumerate}

\noindent The \emph{Avoidance Grid} boundary is given as \emph{intersection} of all boundaries:

\begin{equation}
    Boundary(Avoidance Grid) =  Boundary(Reach Set) \cap Boundary(Sensor Field)
\end{equation}

\noindent The values for \emph{Avoidance Grid Boundary} for our UAS system (sec. \ref{s:UASNonlinearModel}) following:
\begin{enumerate}
    \item distance range $[0m,10m]$,
    \item horizontal range $[-45^\circ,45^\circ]$,
    \item vertical range $[-45^\circ,45^\circ]$,
    \item layer count $10$, layer distance 1m.
\end{enumerate}

The \emph{horizontal cell count} and \emph{vertical cell count} was estimated by \emph{rule of thumb} to have value 7 and 5.

\paragraph{Cell in Avoidance Grid Properties:}\noindent For each cell $\vec{p}\in\R^3$ in the there are properties to be checked:

\begin{enumerate}
    \item \emph{Is there visibility to the cell ?} - how good is an observation of the cell by Sensor Field.
    
    \item \emph{Is there threat present ?} - how sure the data fusion is that there is eminent threat in the cell.
    
    \item \emph{Is the cell reachable ?} - if there is any trajectory which can get UAS to that cell without too much threat along the way.
\end{enumerate}

\noindent The answers to these questions will be given later (tab. \ref{tab:defuzificationRatings}).
